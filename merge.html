<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snap PDF - Merge PDF Files</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf-lib for client-side PDF manipulation -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useRef, useCallback } = React;

      // PDF Merging Service Logic
      const mergePdfs = async (files) => {
        const { PDFDocument } = window.PDFLib;
        const mergedPdf = await PDFDocument.create();

        for (const pdfFile of files) {
          const arrayBuffer = await pdfFile.file.arrayBuffer();
          // Load a PDFDocument from the ArrayBuffer, ignoring minor errors
          const pdfToMerge = await PDFDocument.load(arrayBuffer, {
            ignoreEncryption: true 
          });
          
          const pageIndices = pdfToMerge.getPageIndices();
          const copiedPages = await mergedPdf.copyPages(pdfToMerge, pageIndices);
          copiedPages.forEach((page) => {
            mergedPdf.addPage(page);
          });
        }

        const mergedPdfBytes = await mergedPdf.save();
        return new Blob([mergedPdfBytes], { type: 'application/pdf' });
      };

      // --- React Components ---

      const FileIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 text-red-500" viewBox="0 0 20 20" fill="currentColor">
          <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd" />
        </svg>
      );

      const Header = () => (
        <header className="bg-white shadow-sm w-full py-4 px-6 sticky top-0 z-30">
          <div className="container mx-auto">
            <h1 className="text-2xl font-bold text-red-600">Snap PDF</h1>
          </div>
        </header>
      );

      const FilePreviewCard = ({
        pdfFile,
        onRemove,
        index,
        onDragStart,
        onDragEnter,
        onDragEnd,
        isDragging,
      }) => {
        const handleDragStart = (e) => {
          e.dataTransfer.effectAllowed = 'move';
          onDragStart(index);
        };
        
        const handleDragEnter = () => {
          onDragEnter(index);
        };

        return (
          <div
            draggable
            onDragStart={handleDragStart}
            onDragEnter={handleDragEnter}
            onDragEnd={onDragEnd}
            onDragOver={(e) => e.preventDefault()}
            className={`relative group bg-white border rounded-lg p-4 flex flex-col items-center justify-center text-center shadow-sm transition-all duration-300 transform hover:scale-105 cursor-grab w-48 h-56 ${isDragging ? 'opacity-50 scale-95 border-red-500 ring-2 ring-red-500' : 'opacity-100'}`}
          >
            <button
              onClick={() => onRemove(pdfFile.id)}
              className="absolute top-2 right-2 bg-gray-700 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-red-600"
              aria-label={`Remove ${pdfFile.name}`}
            >
              <span className="text-lg leading-none">&times;</span>
            </button>
            <FileIcon />
            <p className="mt-2 text-sm font-medium text-gray-700 break-words w-full px-2">
              {pdfFile.name}
            </p>
            <div className="absolute bottom-2 left-2 text-sm text-white bg-gray-800 rounded-full w-7 h-7 flex items-center justify-center font-bold">
              {index + 1}
            </div>
          </div>
        );
      };

      const FileDropzone = ({ onFilesAdded }) => {
        const [isDragging, setIsDragging] = useState(false);
        const fileInputRef = useRef(null);

        const handleDragOver = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(true);
        };

        const handleDragLeave = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(false);
        };

        const handleDrop = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(false);
          if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            onFilesAdded(e.dataTransfer.files);
          }
        };

        const handleFileChange = (e) => {
          if (e.target.files && e.target.files.length > 0) {
            onFilesAdded(e.target.files);
          }
        };

        const onButtonClick = () => {
          fileInputRef.current?.click();
        };

        return (
          <div
            className={`flex flex-col items-center justify-center text-center p-8 border-4 border-dashed rounded-xl transition-colors duration-300 ${isDragging ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-white'}`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
          >
            <h2 className="text-4xl font-extrabold mb-2 text-gray-800">Merge PDF files</h2>
            <p className="text-gray-500 mb-8 max-w-md">Combine PDFs in the order you want with the easiest PDF merger available.</p>
            
            <input
              ref={fileInputRef}
              type="file"
              accept="application/pdf"
              multiple
              className="hidden"
              onChange={handleFileChange}
            />
            <button
              onClick={onButtonClick}
              className="bg-red-600 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg hover:bg-red-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300"
            >
              Select PDF files
            </button>
            <p className="mt-4 text-gray-500">or drop PDFs here</p>
          </div>
        );
      };

      const App = () => {
        const [pdfFiles, setPdfFiles] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        const dragItem = useRef(null);
        const dragOverItem = useRef(null);

        const handleFilesAdded = useCallback((files) => {
          setError(null);
          const newFiles = Array.from(files)
            .filter(file => file.type === 'application/pdf')
            .map(file => ({
              id: `${file.name}-${file.lastModified}-${Math.random()}`,
              file,
              name: file.name,
            }));
          
          if (newFiles.length > 0) {
              setPdfFiles(prevFiles => [...prevFiles, ...newFiles]);
          }
        }, []);

        const handleRemoveFile = useCallback((id) => {
          setPdfFiles(prevFiles => prevFiles.filter(file => file.id !== id));
        }, []);

        const handleDragStart = (index) => {
          dragItem.current = index;
        };

        const handleDragEnter = (index) => {
          dragOverItem.current = index;
        };
        
        const handleDragEnd = () => {
          if (dragItem.current !== null && dragOverItem.current !== null && dragItem.current !== dragOverItem.current) {
              const filesCopy = [...pdfFiles];
              const draggedItemContent = filesCopy.splice(dragItem.current, 1)[0];
              filesCopy.splice(dragOverItem.current, 0, draggedItemContent);
              setPdfFiles(filesCopy);
          }
          dragItem.current = null;
          dragOverItem.current = null;
        };
        
        const handleMerge = async () => {
          if (pdfFiles.length < 2) {
            setError("Please select at least two PDF files to merge.");
            return;
          }
          setIsLoading(true);
          setError(null);
          try {
            const mergedPdfBlob = await mergePdfs(pdfFiles);
            const url = URL.createObjectURL(mergedPdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'snap_pdf_merged.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            setPdfFiles([]);
          } catch (e) {
            console.error("Failed to merge PDFs:", e);
            setError("An error occurred while merging the PDFs. Please make sure they are valid PDF files and not password protected.");
          } finally {
            setIsLoading(false);
          }
        };
        
        const handleAddMoreFiles = () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.pdf';
          input.multiple = true;
          input.onchange = (e) => {
              const target = e.target;
              if (target.files) {
                  handleFilesAdded(target.files);
              }
          };
          input.click();
        };

        return (
          <div className="flex flex-col min-h-screen bg-gray-50 font-sans">
            <Header />
            <main className="flex-grow container mx-auto p-4 md:p-8 flex flex-col items-center">
              {pdfFiles.length === 0 ? (
                <div className="w-full max-w-4xl mt-10">
                  <FileDropzone onFilesAdded={handleFilesAdded} />
                </div>
              ) : (
                <>
                  <div className="flex flex-wrap justify-center gap-6 p-4 mb-32 w-full">
                    {pdfFiles.map((pdfFile, index) => (
                      <FilePreviewCard
                        key={pdfFile.id}
                        pdfFile={pdfFile}
                        onRemove={handleRemoveFile}
                        index={index}
                        onDragStart={handleDragStart}
                        onDragEnter={handleDragEnter}
                        onDragEnd={handleDragEnd}
                        isDragging={dragItem.current === index}
                      />
                    ))}
                    <div className="w-48 h-56 flex items-center justify-center">
                       <button 
                          onClick={handleAddMoreFiles}
                          className="w-24 h-24 bg-white border-2 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-gray-400 hover:border-red-500 hover:text-red-500 transition-all duration-300"
                          aria-label="Add more files"
                       >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                          </svg>
                       </button>
                    </div>
                  </div>
                  
                  <div className="fixed bottom-0 left-0 right-0 bg-white p-4 border-t z-20">
                    <div className="container mx-auto flex flex-col items-center justify-center">
                       {error && <p className="text-red-600 mb-4 text-center">{error}</p>}
                      <button
                        onClick={handleMerge}
                        disabled={isLoading || pdfFiles.length < 2}
                        className="bg-red-600 text-white font-bold py-4 px-16 rounded-lg text-xl shadow-lg hover:bg-red-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none"
                      >
                        {isLoading ? 'Merging...' : `Merge PDF files`}
                      </button>
                    </div>
                  </div>
                </>
              )}
            </main>
          </div>
        );
      };

      // --- Application Entry Point ---
      
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
